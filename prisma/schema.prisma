generator client {
  provider        = "prisma-client"
  output          = "../app/generated/prisma"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["slopwork"]
}

// --- Enums ---

enum TaskType {
  QUOTE
  COMPETITION
  CAMPAIGN

  @@schema("slopwork")
}

enum TaskStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  DISPUTED
  CANCELLED
  PAUSED

  @@schema("slopwork")
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
  FUNDED
  PAYMENT_REQUESTED
  COMPLETED
  DISPUTED

  @@schema("slopwork")
}

enum DisputeStatus {
  PENDING
  ACCEPTED
  DENIED

  @@schema("slopwork")
}

enum DisputeRaisedBy {
  CREATOR
  BIDDER

  @@schema("slopwork")
}

enum NotificationType {
  NEW_BID
  BID_ACCEPTED
  BID_REJECTED
  ESCROW_FUNDED
  PAYMENT_REQUESTED
  PAYMENT_APPROVED
  NEW_MESSAGE
  DISPUTE_RAISED
  DISPUTE_RESOLVED
  SUBMISSION_RECEIVED
  CAMPAIGN_SUBMISSION_APPROVED
  CAMPAIGN_SUBMISSION_REJECTED
  CAMPAIGN_PAYMENT_REQUEST
  CAMPAIGN_PAYMENT_COMPLETED
  CAMPAIGN_CREATOR_REJECTED
  CAMPAIGN_BANNED

  @@schema("slopwork")
}

enum CampaignSubmissionStatus {
  PENDING_PAYMENT
  READING_VIEWS
  CHECKING_CONTENT
  APPROVED
  PAYMENT_REQUESTED
  REJECTED
  CREATOR_REJECTED
  PAID
  PAYMENT_FAILED

  @@schema("slopwork")
}

enum CampaignPaymentRequestStatus {
  PENDING
  PAID
  CANCELLED

  @@schema("slopwork")
}

enum PaymentToken {
  SOL
  USDC
  CUSTOM

  @@schema("slopwork")
}

// --- Models ---

model User {
  id            String   @id @default(uuid())
  walletAddress String   @unique
  username      String?  @unique
  profilePicUrl String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // X (Twitter) account linking
  xUserId         String?   @unique
  xUsername        String?
  xAccessToken    String?
  xRefreshToken   String?
  xTokenExpiresAt DateTime?

  // Referral program
  referralCode      String?    @unique
  welcomeShown      Boolean    @default(false)

  tasks                Task[]               @relation("TaskCreator")
  bids                 Bid[]                @relation("Bidder")
  sentMessages         Message[]            @relation("MessageSender")
  receivedMessages     Message[]            @relation("MessageRecipient")
  notifications        Notification[]       @relation("UserNotifications")
  campaignSubmissions  CampaignSubmission[] @relation("CampaignSubmitter")
  bansIssued           CampaignBan[]        @relation("BanCreator")
  bansReceived         CampaignBan[]        @relation("BannedUser")
  sharedCampaigns      CampaignShare[]      @relation("SharedCampaigns")
  xScores              XScoreData[]
  referralsMade        Referral[]           @relation("Referrer")
  referredByRecord     Referral?            @relation("ReferredUser")
  paymentRequests      CampaignPaymentRequest[] @relation("PaymentRequester")

  @@index([walletAddress])
  @@index([username])
  @@schema("slopwork")
}

model AuthNonce {
  id            String   @id @default(uuid())
  walletAddress String
  nonce         String   @unique
  expiresAt     DateTime
  createdAt     DateTime @default(now())

  @@index([walletAddress])
  @@index([expiresAt])
  @@schema("slopwork")
}

model Task {
  id                  String     @id @default(uuid())
  creatorId           String
  title               String
  description         String
  budgetLamports      BigInt
  taskType            TaskType   @default(QUOTE)
  status              TaskStatus @default(OPEN)
  paymentTxSignature  String     @unique
  multisigAddress     String?
  vaultAddress        String?
  paymentToken        PaymentToken @default(SOL)
  customTokenMint     String?
  customTokenSymbol   String?
  customTokenDecimals Int?
  customTokenLogoUri  String?
  winningBidId        String?    @unique
  maxWinners          Int        @default(1)
  prizeStructure      Json?      // [{place:1, amountLamports:"500000000"}, {place:2, amountLamports:"300000000"}]
  isPublicFeed        Boolean    @default(false)
  deadlineAt          DateTime?
  imageUrl            String?
  imageTransform      Json?      // { scale: number, x: number, y: number } for image positioning
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  creator             User                @relation("TaskCreator", fields: [creatorId], references: [id])
  winningBid          Bid?                @relation("WinningBid", fields: [winningBidId], references: [id])
  bids                Bid[]               @relation("TaskBids")
  messages            Message[]
  campaignConfig          CampaignConfig?
  campaignSubmissions     CampaignSubmission[]
  campaignPaymentRequests CampaignPaymentRequest[]
  campaignShares          CampaignShare[]

  @@index([creatorId])
  @@index([status])
  @@index([createdAt])
  @@schema("slopwork")
}

model Bid {
  id               String    @id @default(uuid())
  taskId           String
  bidderId         String
  amountLamports   BigInt
  description      String
  multisigAddress  String?
  vaultAddress     String?
  fundingTxSig     String?
  proposalIndex    Int?
  paymentTxSig     String?
  winnerPlace      Int?
  status           BidStatus @default(PENDING)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  task             Task      @relation("TaskBids", fields: [taskId], references: [id])
  bidder           User      @relation("Bidder", fields: [bidderId], references: [id])
  wonTask          Task?     @relation("WinningBid")
  disputes         Dispute[]
  submissions      Submission[]

  @@unique([fundingTxSig])
  @@index([taskId])
  @@index([bidderId])
  @@index([status])
  @@schema("slopwork")
}

model Message {
  id          String   @id @default(uuid())
  taskId      String
  senderId    String
  recipientId String?  // The other party in the private conversation. Null for legacy public messages.
  content     String
  attachments Json?    // Array of { url, key, contentType, size, filename }
  createdAt   DateTime @default(now())

  task        Task     @relation(fields: [taskId], references: [id])
  sender      User     @relation("MessageSender", fields: [senderId], references: [id])
  recipient   User?    @relation("MessageRecipient", fields: [recipientId], references: [id])

  @@index([taskId, createdAt])
  @@index([senderId])
  @@index([recipientId])
  @@index([taskId, senderId, recipientId])
  @@schema("slopwork")
}

model Dispute {
  id               String          @id @default(uuid())
  bidId            String
  raisedBy         DisputeRaisedBy
  raisedByWallet   String
  proposalIndex    Int             // On-chain proposal index for this dispute
  proposalTxSig    String          // Tx signature of the proposal creation
  reason           String
  evidenceUrls     String[]        @default([])
  status           DisputeStatus   @default(PENDING)
  responseReason   String?         // Respondent's counter-argument
  responseEvidence String[]        @default([])
  resolutionNotes  String?
  resolvedByWallet String?
  resolveTxSig     String?         // If accepted: the arbiter's approve tx signature
  executeTxSig     String?         // If accepted: the execute tx signature
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  resolvedAt       DateTime?

  bid              Bid             @relation(fields: [bidId], references: [id])

  @@index([bidId])
  @@index([status])
  @@index([createdAt])
  @@schema("slopwork")
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  linkUrl   String
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user      User             @relation("UserNotifications", fields: [userId], references: [id])

  @@index([userId, read, createdAt])
  @@schema("slopwork")
}

model Submission {
  id            String    @id @default(uuid())
  bidId         String
  description   String
  attachments   Json?     // Array of { url, key, contentType, size, filename }
  postUrl       String?
  xPostId       String?
  postText      String?
  postMedia     Json?     // Array of { type, url?, previewImageUrl? }
  postAuthorName String?
  postAuthorUsername String?
  postAuthorProfilePic String?
  viewCount     Int?
  likeCount     Int?
  retweetCount  Int?
  commentCount  Int?
  metricsReadAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  bid           Bid       @relation(fields: [bidId], references: [id])

  @@index([bidId])
  @@schema("slopwork")
}

model CampaignConfig {
  id                      String  @id @default(cuid())
  taskId                  String  @unique
  cpmLamports             BigInt    // Cost per 1000 views in lamports
  budgetRemainingLamports BigInt    // Tracks remaining budget
  guidelines              Json      // { dos: string[], donts: string[] }
  heading                 String?   // Short heading shown on campaign card instead of description
  minViews                Int     @default(100)
  minLikes                Int     @default(0)
  minRetweets             Int     @default(0)
  minComments             Int     @default(0)
  minPayoutLamports       BigInt  @default(0)  // Minimum cumulative payout before user can request payment
  maxBudgetPerUserPercent Float?  // Max % of total budget a single user can earn (null = no limit)
  maxBudgetPerPostPercent Float?  // Max % of total budget a single post can earn (null = no limit)
  minKloutScore           Int?    // Minimum Klout score required to participate (null = no requirement)
  requireFollowX          String?   // X username the participant should follow (null = not required)
  collateralLink          String?   // Optional link to Google Drive / Dropbox with campaign collateral for creators
  bonusMinKloutScore      Int?    // Minimum Klout score to qualify for the flat one-time bonus (null = no bonus)
  bonusMaxLamports        BigInt? // Maximum bonus amount for the highest scorer (null = no bonus)

  task                    Task    @relation(fields: [taskId], references: [id])

  @@schema("slopwork")
}

model CampaignPaymentRequest {
  id                      String                          @id @default(cuid())
  taskId                  String
  requesterId             String
  totalPayoutLamports     BigInt
  status                  CampaignPaymentRequestStatus    @default(PENDING)
  paymentTxSig            String?
  paymentProposalIndex    BigInt?
  createdAt               DateTime                        @default(now())
  updatedAt               DateTime                        @updatedAt

  task                    Task                            @relation(fields: [taskId], references: [id])
  requester               User                            @relation("PaymentRequester", fields: [requesterId], references: [id])
  submissions             CampaignSubmission[]            @relation("PaymentRequestSubmissions")

  @@index([taskId])
  @@index([requesterId])
  @@index([status])
  @@schema("slopwork")
}

model CampaignSubmission {
  id                      String                   @id @default(cuid())
  taskId                  String
  submitterId             String
  postUrl                 String
  xPostId                 String
  viewCount               Int?
  likeCount               Int?
  retweetCount            Int?
  commentCount            Int?
  viewsReadAt             DateTime?
  apiFeeTxSig             String?
  contentCheckPassed      Boolean?
  contentCheckExplanation String?
  payoutLamports          BigInt?
  flatBonusLamports       BigInt?  // One-time Klout score-based flat bonus (null = no bonus applied)
  kloutScoreAtSubmission  Float?
  cpmMultiplierApplied    Float?
  status                  CampaignSubmissionStatus @default(PENDING_PAYMENT)
  rejectionReason         String?
  paymentTxSig            String?
  paymentProposalIndex    BigInt?
  paymentRequestId        String?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt

  task                    Task                     @relation(fields: [taskId], references: [id])
  submitter               User                     @relation("CampaignSubmitter", fields: [submitterId], references: [id])
  paymentRequest          CampaignPaymentRequest?  @relation("PaymentRequestSubmissions", fields: [paymentRequestId], references: [id])

  @@unique([taskId, xPostId])
  @@index([taskId])
  @@index([submitterId])
  @@index([status])
  @@index([paymentRequestId])
  @@schema("slopwork")
}

model CampaignBan {
  id            String   @id @default(cuid())
  creatorId     String
  bannedUserId  String
  reason        String?
  createdAt     DateTime @default(now())

  creator       User     @relation("BanCreator", fields: [creatorId], references: [id])
  bannedUser    User     @relation("BannedUser", fields: [bannedUserId], references: [id])

  @@unique([creatorId, bannedUserId])
  @@index([creatorId])
  @@index([bannedUserId])
  @@schema("slopwork")
}

model CampaignShare {
  id            String   @id @default(cuid())
  taskId        String
  sharedWithId  String
  createdAt     DateTime @default(now())

  task          Task     @relation(fields: [taskId], references: [id])
  sharedWith    User     @relation("SharedCampaigns", fields: [sharedWithId], references: [id])

  @@unique([taskId, sharedWithId])
  @@index([taskId])
  @@index([sharedWithId])
  @@schema("slopwork")
}

model KloutScore {
  id        String  @id
  name      String?
  username  String?
  image     String?
  twitterId String?
  score     Float   @default(0)
  rank      Int

  @@index([score])
  @@schema("slopwork")
}

model XScoreData {
  id                String   @id @default(uuid())
  userId            String
  xUserId           String
  xUsername          String

  // Raw profile data
  followersCount    Int
  followingCount    Int
  tweetCount        Int
  listedCount       Int?
  verifiedType      String?   // "blue", "business", "government", or null
  location          String?   // Raw location string from X profile
  profileImageUrl   String?

  // Parsed geo
  geoTier           Int?      // 1=US/CA, 2=W.Europe/AU/NZ, 3=E.Europe/Asia, 4=Africa/Other
  geoRegion         String?   // Parsed region/country name

  // Aggregated tweet metrics (from last N tweets)
  tweetsAnalyzed    Int
  avgLikes          Float
  avgRetweets       Float
  avgReplies        Float
  avgViews          Float

  // Raw data blobs for future use
  rawProfileData    Json?     // Full profile response from X API
  rawTweetsData     Json?     // Array of tweet objects with metrics

  // Computed score components
  reachScore        Float
  ratioScore        Float
  engagementScore   Float
  verificationScore Float
  geoMultiplier     Float
  qualityScore      Float     // reachScore * engagementScore + ratioScore + verificationScore
  totalScore        Float     // qualityScore * geoMultiplier * 100

  // Buffed profile image
  buffedImageUrl    String?   // AI-generated buffed version of profile pic
  tierQuote         String?   // Random quote from the user's score tier

  // Payment
  feeTxSignature    String    @unique

  createdAt         DateTime  @default(now())

  user              User      @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([totalScore])
  @@schema("slopwork")
}

// --- Referral Program ---

model Referral {
  id              String    @id @default(uuid())
  referrerId      String
  referredUserId  String    @unique // A user can only be referred once
  referralCode    String    // Snapshot of the code used
  tierNumber      Int       // 1-10 tier at time of signup
  referrerFeePct  Int       // 10-100 â€” referrer's % of the 10% platform fee
  globalPosition  Int       // Position in global referral count at signup
  completedAt     DateTime? // Set when referred user gets a Klout score
  createdAt       DateTime  @default(now())

  referrer        User      @relation("Referrer", fields: [referrerId], references: [id])
  referredUser    User      @relation("ReferredUser", fields: [referredUserId], references: [id])
  earnings        ReferralEarning[]

  @@index([referrerId])
  @@index([createdAt])
  @@schema("slopwork")
}

model ReferralEarning {
  id              String       @id @default(uuid())
  referralId      String
  referrerId      String       // Denormalized for fast queries
  referredUserId  String       // The user who performed the task
  taskId          String?
  submissionId    String?      // For campaign submissions
  bidId           String?      // For quote/competition bids
  tokenType       PaymentToken
  tokenMint       String?      // For custom SPL tokens
  totalAmount     BigInt       // Total payment amount (gross)
  referrerAmount  BigInt       // Amount earned by referrer
  platformAmount  BigInt       // Amount that went to platform
  txSignature     String?
  createdAt       DateTime     @default(now())

  referral        Referral     @relation(fields: [referralId], references: [id])

  @@index([referrerId])
  @@index([referredUserId])
  @@index([referralId])
  @@index([createdAt])
  @@schema("slopwork")
}
